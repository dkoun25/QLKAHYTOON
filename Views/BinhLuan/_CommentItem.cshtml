@model QLKAHYTOON.Models.binhluan
@{
    var user = ViewBag.User as QLKAHYTOON.Models.nguoidung;
    var admin = ViewBag.User as QLKAHYTOON.Models.admin;
    bool isAdmin = Session["IsAdmin"] != null && (bool)Session["IsAdmin"];

    var replies = ViewData["Replies_" + Model.MaBinhLuan] as List<QLKAHYTOON.Models.binhluan>;

    // Kiểm tra xem người bình luận có phải admin không
    bool isCommentByAdmin = Model.MaNguoiDung != null && Model.MaNguoiDung.StartsWith("AD");

    // Lấy thông tin người bình luận
    string commentAvatar = "/Anh/avatar-default.png";
    string commentName = "Người dùng";

    if (isCommentByAdmin)
    {
        var adminInfo = ViewContext.Controller.ViewBag.db != null
            ? ((QLKAHYTOON.Models.QLKAHYTOONDataContext)ViewContext.Controller.ViewBag.db).admins
                .FirstOrDefault(a => a.MaAdmin == Model.MaNguoiDung)
            : null;

        if (adminInfo != null)
        {
            commentName = adminInfo.HoTen;
            commentAvatar = "/Anh/admin-avatar.png";
        }
    }
    else if (Model.nguoidung != null)
    {
        commentName = Model.nguoidung.HoTen;
        commentAvatar = Model.nguoidung.Avatar ?? "/Anh/avatar-default.png";
    }
}

<div class="comment-item d-flex mb-3 p-2" id="cmt-@Model.MaBinhLuan" style="border-bottom: 1px dashed #ddd;">
    <img src="@commentAvatar" class="rounded-circle me-3" style="width:45px; height:45px; object-fit:cover; border: 1px solid #ddd;">
    <div class="flex-grow-1">
        <div class="d-flex align-items-center flex-wrap">
            <span class="me-2 fw-bold text-dark">@commentName</span>

            @* Badge Admin *@
            @if (isCommentByAdmin)
            {
                <span class="badge bg-danger me-2" style="font-size: 0.7rem;">
                    <i class="fa fa-shield"></i> ADMIN
                </span>
            }

            @if (Model.chuong != null)
            {
                <span class="badge bg-warning text-dark me-2" style="font-size: 0.75rem;">Chapter @Model.chuong.SoChuong</span>
            }
            <small class="text-muted">@((Model.NgayDang ?? DateTime.Now).ToString("dd/MM/yyyy HH:mm"))</small>
        </div>

        <div class="mt-1 text-dark">@Model.NoiDung</div>

        <div class="mt-2">
            <button class="btn-action me-3" onclick="likeComment('@Model.MaBinhLuan')">
                <i class="fa-regular fa-thumbs-up"></i> <span id="like-count-@Model.MaBinhLuan">@Model.LuotLike</span> Thích
            </button>
            <button class="btn-action me-3" onclick="toggleReplyBox('@Model.MaBinhLuan')">Trả lời</button>

            @* User chỉ xóa comment của mình, Admin xóa được mọi comment *@
            @if ((user != null && user.MaNguoiDung == Model.MaNguoiDung) ||
                 (isAdmin && admin != null))
            {
                <button class="btn-action text-danger" onclick="deleteComment('@Model.MaBinhLuan')">
                    <i class="fa-solid fa-trash"></i> Xóa
                </button>
            }
        </div>

        <div class="reply-box mt-2" id="reply-box-@Model.MaBinhLuan" style="display:none;">
            @if (user != null || admin != null)
            {
                <div class="d-flex">
                    <textarea id="txtReply-@Model.MaBinhLuan" class="form-control sm-textarea me-2" rows="1" placeholder="Trả lời @commentName..."></textarea>
                    <button class="btn btn-sm btn-primary" onclick="submitComment('@Model.MaBinhLuan')">Gửi</button>
                </div>
            }
        </div>

        @if (replies != null && replies.Count > 0)
        {
            <div class="replies-list ms-4 mt-2 ps-3" style="border-left: 3px solid #e9ecef;">
                @foreach (var child in replies)
                {
                    @Html.Partial("_CommentItem", child)
                }
            </div>
        }
    </div>
</div>

<style>
    .badge.bg-danger {
        background: linear-gradient(135deg, #dc3545, #c82333) !important;
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        font-weight: 600;
        padding: 4px 8px;
    }
</style>