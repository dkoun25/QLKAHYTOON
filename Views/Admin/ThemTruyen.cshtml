@model QLKAHYTOON.Models.thongtintruyen
@{
    var isEdit = ViewBag.IsEdit ?? false;
    ViewBag.Title = isEdit ? "Sửa Truyện" : "Thêm Truyện Mới";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var listTheLoai = ViewBag.ListTheLoai as List<QLKAHYTOON.Models.theloai>;
    var selectedGenres = ViewBag.SelectedGenres as List<string> ?? new List<string>();
}

<h2>@ViewBag.Title</h2>
<hr />

@using (Html.BeginForm(isEdit ? "SuaTruyen" : "ThemTruyen", "Admin", FormMethod.Post, new { enctype = "multipart/form-data" }))
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="form-group">
            <label class="control-label col-md-2">Mã Truyện</label>
            <div class="col-md-10">
                <input type="text" name="MaTruyen" class="form-control"
                       value="@(Model != null ? Model.MaTruyen : ViewBag.MaTruyenAuto)"
                       readonly style="background-color: #eee; font-weight: bold;" />
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Tên Truyện</label>
            <div class="col-md-10">
                @Html.EditorFor(model => model.TenTruyen, new { htmlAttributes = new { @class = "form-control", @required = "required" } })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Tác Giả</label>
            <div class="col-md-10">
                @Html.EditorFor(model => model.TacGia, new { htmlAttributes = new { @class = "form-control", @required = "required" } })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Mô Tả / Tóm Tắt</label>
            <div class="col-md-10">
                @Html.TextAreaFor(model => model.Slug, new { @class = "form-control", @rows = "5", @placeholder = "Nhập nội dung tóm tắt truyện tại đây..." })
                @Html.ValidationMessageFor(model => model.Slug, "", new { @class = "text-danger" })
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Trạng Thái</label>
            <div class="col-md-10">
                @if (isEdit)
                {
                    <select class="form-control" name="TrangThai">
                        <option value="Đang cập nhật" @(Model.TrangThai == "Đang cập nhật" ? "selected" : "")>Đang cập nhật</option>
                        <option value="Hoàn thành" @(Model.TrangThai == "Hoàn thành" ? "selected" : "")>Hoàn thành</option>
                        <option value="Tạm ngưng" @(Model.TrangThai == "Tạm ngưng" ? "selected" : "")>Tạm ngưng</option>
                    </select>
                }
                else
                {
                    <select class="form-control" name="TrangThai">
                        <option value="Đang cập nhật">Đang cập nhật</option>
                        <option value="Hoàn thành">Hoàn thành</option>
                        <option value="Tạm ngưng">Tạm ngưng</option>
                    </select>
                }
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Ảnh Bìa</label>
            <div class="col-md-10">
                @if (isEdit && Model != null && !string.IsNullOrEmpty(Model.AnhTruyen))
                {
                    <div style="margin-bottom: 10px;">
                        <p><strong>Ảnh hiện tại:</strong></p>
                        <img src="@Url.Content(Model.AnhTruyen)" alt="Ảnh bìa hiện tại"
                             style="max-width: 200px; max-height: 300px; border: 2px solid #ddd; border-radius: 4px;" />
                    </div>
                    <input type="file" name="fileAnh" class="form-control" accept="image/*" />
                    <p class="help-block">
                        <i class="fa fa-info-circle"></i> Chỉ chọn ảnh mới nếu bạn muốn thay đổi ảnh bìa. Để trống nếu giữ nguyên ảnh hiện tại.
                    </p>
                }
                else
                {
                    <input type="file" name="fileAnh" class="form-control" accept="image/*" required />
                    <p class="help-block">
                        <i class="fa fa-exclamation-circle"></i> Bắt buộc phải chọn ảnh bìa cho truyện mới.
                    </p>
                }
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Thể Loại</label>
            <div class="col-md-10">
                <div class="row" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-left: 0; border-radius: 4px;">
                    @if (listTheLoai != null)
                    {
                        foreach (var item in listTheLoai)
                        {
                            bool isChecked = false;

                            if (isEdit)
                            {
                                isChecked = selectedGenres.Any(sg => sg.Trim() == item.MaTheLoai.Trim());
                            }

                            <div class="col-md-4 col-sm-6">
                                <label style="font-weight: normal; cursor: pointer;">
                                    <input type="checkbox" name="theloai" value="@item.MaTheLoai"
                                           @(isChecked ? "checked" : "") />
                                    @item.TenTheLoai
                                </label>
                            </div>
                        }
                    }
                </div>
                <p class="help-block">Bạn có thể chọn nhiều thể loại.</p>
            </div>
        </div>

        <div class="form-group">
            <div class="col-md-offset-2 col-md-10">
                <button type="submit" class="btn @(isEdit ? "btn-warning" : "btn-success")">
                    <i class="fa @(isEdit ? "fa-save" : "fa-plus")"></i>
                    @(isEdit ? "Cập Nhật Truyện" : "Lưu Truyện")
                </button>
                <a href="@Url.Action("QuanLyTruyen", "Admin")" class="btn btn-default">
                    <i class="fa fa-arrow-left"></i> Quay lại
                </a>
            </div>
        </div>
    </div>
}

<style>
    .help-block {
        font-size: 13px;
        color: #666;
        margin-top: 5px;
    }

        .help-block i {
            margin-right: 5px;
        }

    .form-group img {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
</style>