@model IEnumerable<QLKAHYTOON.Models.thongtintruyen>
@{
    ViewBag.Title = "Quản Lý Truyện";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    var tongSoTruyen = ViewBag.TongSoTruyen ?? 0;
    int currentPage = ViewBag.CurrentPage;
    int totalPages = ViewBag.TotalPages;
}

<h2>Quản Lý Truyện</h2>

<p>
    <a href="@Url.Action("ThemTruyen", "Admin")" class="btn btn-success">
        <i class="fa fa-plus"></i> Thêm Truyện Mới
    </a>
    <span class="text-muted" style="margin-left: 20px;">
        <i class="fa fa-book"></i> Tổng số: <strong>@tongSoTruyen</strong> truyện
    </span>
</p>

@if (TempData["UploadSuccess"] != null)
{
    <div class="alert alert-success alert-dismissible fade in">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <i class="fa fa-check-circle"></i> @TempData["UploadSuccess"]
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade in">
        <button type="button" class="close" data-dismiss="alert">&times;</button>
        <i class="fa fa-exclamation-circle"></i> @TempData["Error"]
    </div>
}

<div class="table-responsive">
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th style="width: 80px;">Ảnh Bìa</th>
                <th>Tên Truyện</th>
                <th>Tác Giả</th>
                <th style="width: 200px;">Thể Loại</th>
                <th style="width: 120px;">Trạng Thái</th>
                <th style="width: 300px;">Chức năng</th>
            </tr>
        </thead>
        <tbody>
            @{
                var truyenTheLoaiDict = ViewBag.TruyenTheLoaiDict as Dictionary<string, List<string>>;
            }

            @foreach (var item in Model)
            {
                var theLoaiNames = truyenTheLoaiDict != null && truyenTheLoaiDict.ContainsKey(item.MaTruyen)
                    ? truyenTheLoaiDict[item.MaTruyen]
                    : new List<string>();

                <tr>
                    <td>
                        <img src="@Url.Content(item.AnhTruyen)" alt="@item.TenTruyen"
                             style="width: 60px; height: 90px; object-fit: cover; border-radius: 4px;" />
                    </td>
                    <td>
                        <strong>@Html.DisplayFor(modelItem => item.TenTruyen)</strong>
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.TacGia)
                    </td>
                    <td>
                        @if (theLoaiNames != null && theLoaiNames.Any())
                        {
                            <div class="theloai-badges">
                                @foreach (var tenTheLoai in theLoaiNames)
                                {
                                    <span class="badge badge-theloai">@tenTheLoai</span>
                                }
                            </div>
                        }
                        else
                        {
                            <span class="text-muted"><i>Chưa có thể loại</i></span>
                        }
                    </td>
                    <td>
                        @if (item.TrangThai == "Đang cập nhật")
                        {
                            <span class="label label-info">@item.TrangThai</span>
                        }
                        else if (item.TrangThai == "Hoàn thành")
                        {
                            <span class="label label-success">@item.TrangThai</span>
                        }
                        else
                        {
                            <span class="label label-default">@item.TrangThai</span>
                        }
                    </td>
                    <td>
                        @Html.ActionLink("Thêm Chương", "ThemChuong", "Admin",
                                           new { maTruyen = item.MaTruyen.Trim() },
                                           new { @class = "btn btn-primary btn-sm" })

                        @Html.ActionLink("Sửa", "SuaTruyen", "Admin",
                                           new { maTruyen = item.MaTruyen.Trim() },
                                           new { @class = "btn btn-warning btn-sm" })

                        <a href="@Url.Action("XoaTruyen", "Admin", new { maTruyen = item.MaTruyen.Trim() })"
                           class="btn btn-danger btn-sm"
                           onclick="return confirm('Bạn có chắc chắn muốn xóa truyện này? Tất cả chương và dữ liệu liên quan sẽ bị xóa!');">
                            Xóa
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<nav class="mt-4 d-flex justify-content-center">
    <ul class="pagination">
        @* Nút Trước *@
        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("QuanLyTruyen", "Admin", new { page = currentPage - 1 })">
                <i class="fa fa-chevron-left"></i> Trước
            </a>
        </li>
        @{
            int startPage = Math.Max(1, currentPage - 2);
            int endPage = Math.Min(totalPages, currentPage + 2);

            // Điều chỉnh để luôn hiển thị 5 trang nếu có thể
            if (endPage - startPage < 4)
            {
                if (startPage == 1)
                {
                    endPage = Math.Min(totalPages, startPage + 4);
                }
                else if (endPage == totalPages)
                {
                    startPage = Math.Max(1, endPage - 4);
                }
            }
        }

        @* Trang đầu tiên nếu không nằm trong khoảng *@
        @if (startPage > 1)
        {
            <li class="page-item">
                <a class="page-link" href="@Url.Action("QuanLyTruyen", "Admin", new { page = 1 })">1</a>
            </li>
            if (startPage > 2)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
        }

        @* Các trang trong khoảng *@
        @for (int i = startPage; i <= endPage; i++)
        {
            <li class="page-item @(currentPage == i ? "active" : "")">
                <a class="page-link" href="@Url.Action("QuanLyTruyen", "Admin", new { page = i })">@i</a>
            </li>
        }

        @* Trang cuối cùng nếu không nằm trong khoảng*@
        @if (endPage < totalPages)
        {
            if (endPage < totalPages - 1)
            {
                <li class="page-item disabled"><span class="page-link">...</span></li>
            }
            <li class="page-item">
                <a class="page-link" href="@Url.Action("QuanLyTruyen", "Admin", new { page = totalPages })">@totalPages</a>
            </li>
        }

        @* Nút Sau *@
        <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
            <a class="page-link" href="@Url.Action("QuanLyTruyen", "Admin", new { page = currentPage + 1 })">
                Sau <i class="fa fa-chevron-right"></i>
            </a>
        </li>
    </ul>
</nav>

<style>
    .label {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .label-info {
        background: #3498db;
        color: white;
    }

    .label-success {
        background: #2ecc71;
        color: white;
    }

    .label-default {
        background: #95a5a6;
        color: white;
    }

    .theloai-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }

    .badge-theloai {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        display: inline-block;
        white-space: nowrap;
    }

    .badge-theloai:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
    }

    .pagination {
        display: inline-flex;
        padding-left: 0;
        margin: 20px 0;
        border-radius: 4px;
        list-style: none;
    }

    .pagination .page-item {
        display: inline;
    }

    .pagination .page-link {
        position: relative;
        display: block;
        padding: 10px 16px;
        margin-left: -1px;
        line-height: 1.42857143;
        color: #667eea;
        text-decoration: none;
        background-color: #fff;
        border: 1px solid #ddd;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .pagination .page-item:first-child .page-link {
        margin-left: 0;
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
    }

    .pagination .page-item:last-child .page-link {
        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;
    }

    .pagination .page-link:hover,
    .pagination .page-link:focus {
        z-index: 2;
        color: #fff;
        background-color: #764ba2;
        border-color: #764ba2;
    }

    .pagination .page-item.active .page-link {
        z-index: 3;
        color: #fff;
        cursor: default;
        background-color: #667eea;
        border-color: #667eea;
    }

    .pagination .page-item.disabled .page-link {
        color: #999;
        cursor: not-allowed;
        background-color: #fff;
        border-color: #ddd;
        pointer-events: none;
    }

    .table-responsive {
        margin-bottom: 20px;
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .pagination .page-link {
            padding: 6px 10px;
            font-size: 12px;
        }
    }
</style>