@model QLKAHYTOON.Models.nguoidung
@{
    ViewBag.Title = "Cài đặt tài khoản";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .settings-container {
        max-width: 900px;
        margin: 30px auto;
        padding: 20px;
    }

    .settings-header {
        text-align: center;
        margin-bottom: 40px;
        color: #fff;
    }

    .settings-card {
        background: #2d2d2d;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .avatar-section {
        text-align: center;
        margin-bottom: 40px;
    }

    .avatar-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
    }

    .avatar-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #444;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .avatar-preview:hover {
            border-color: #2196F3;
            transform: scale(1.05);
        }

    .avatar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }

    .avatar-wrapper:hover .avatar-overlay {
        opacity: 1;
    }

    .avatar-overlay i {
        font-size: 30px;
        color: white;
    }

    .section-title {
        color: #fff;
        font-size: 20px;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #444;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        color: #aaa;
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
    }

    .form-control {
        background: #1a1a1a;
        border: 1px solid #444;
        color: #fff;
        padding: 12px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

        .form-control:focus {
            background: #222;
            border-color: #2196F3;
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
            color: #fff;
        }

    .btn-save {
        background: linear-gradient(135deg, #2196F3, #1976D2);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

    .btn-change-password {
        background: linear-gradient(135deg, #FF9800, #F57C00);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .btn-change-password:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.4);
        }

    .alert {
        border-radius: 8px;
        border: none;
    }

    #fileUpload {
        display: none;
    }
</style>

<div class="container settings-container">
    <div class="settings-header">
        <h2><i class="fas fa-cog"></i> Cài đặt tài khoản</h2>
        <p class="text-muted">Quản lý thông tin cá nhân và bảo mật</p>
    </div>

    <!-- AVATAR SECTION -->
    <div class="settings-card">
        <div class="avatar-section">
            <div class="avatar-wrapper">
                <img id="avatarPreview"
                     src="@(string.IsNullOrEmpty(Model.Avatar) ? "/Anh/Avatar/default-avatar.png" : Model.Avatar)"
                     alt="Avatar"
                     class="avatar-preview"
                     onclick="document.getElementById('fileUpload').click()">
                <div class="avatar-overlay" onclick="document.getElementById('fileUpload').click()">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="fileUpload" accept="image/*" onchange="uploadAvatar()" />
            <p class="text-muted mt-2">
                <small>Click vào ảnh để thay đổi (JPG, PNG, GIF - Tối đa 5MB)</small>
            </p>
        </div>
    </div>

    <!-- THÔNG TIN CÁ NHÂN -->
    <div class="settings-card">
        <h3 class="section-title">
            <i class="fas fa-user"></i> Thông tin cá nhân
        </h3>

        <div id="profileMessage"></div>

        <div class="form-group">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" class="form-control" value="@Model.TenDangNhap" readonly disabled>
            <small class="text-muted">Không thể thay đổi tên đăng nhập</small>
        </div>

        <div class="form-group">
            <label class="form-label">Họ và tên</label>
            <input type="text" id="txtHoTen" class="form-control" value="@Model.HoTen" placeholder="Nhập họ tên">
        </div>

        <div class="form-group">
            <label class="form-label">Số điện thoại</label>
            <input type="text" id="txtSoDienThoai" class="form-control" value="@Model.SoDienThoai" placeholder="Nhập số điện thoại">
        </div>

        <button type="button" class="btn btn-save" onclick="capNhatThongTin()">
            <i class="fas fa-save"></i> Lưu thay đổi
        </button>
    </div>

    <!-- ĐỔI MẬT KHẨU -->
    <div class="settings-card">
        <h3 class="section-title">
            <i class="fas fa-lock"></i> Đổi mật khẩu
        </h3>

        <div id="passwordMessage"></div>

        <div class="form-group">
            <label class="form-label">Mật khẩu hiện tại</label>
            <input type="password" id="txtMatKhauCu" class="form-control" placeholder="Nhập mật khẩu hiện tại">
        </div>

        <div class="form-group">
            <label class="form-label">Mật khẩu mới</label>
            <input type="password" id="txtMatKhauMoi" class="form-control" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)">
        </div>

        <div class="form-group">
            <label class="form-label">Xác nhận mật khẩu mới</label>
            <input type="password" id="txtXacNhanMatKhau" class="form-control" placeholder="Nhập lại mật khẩu mới">
        </div>

        <button type="button" class="btn btn-change-password" onclick="doiMatKhau()">
            <i class="fas fa-key"></i> Đổi mật khẩu
        </button>
    </div>
</div>

@section scripts {
    <script>
        function uploadAvatar() {
            var fileInput = document.getElementById('fileUpload');
            var file = fileInput.files[0];

            if (!file) return;

            // Preview ảnh trước khi upload
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Upload lên server
            var formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '@Url.Action("UploadAvatar", "Users")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.success) {
                        alert('✅ ' + res.msg);
                        document.getElementById('avatarPreview').src = res.avatarUrl;
                    } else {
                        alert('❌ ' + res.msg);
                        location.reload();
                    }
                },
                error: function() {
                    alert('❌ Lỗi kết nối server!');
                    location.reload();
                }
            });
        }

        function capNhatThongTin() {
            var hoTen = $('#txtHoTen').val().trim();
            var soDienThoai = $('#txtSoDienThoai').val().trim();

            if (!hoTen) {
                showMessage('profileMessage', 'Vui lòng nhập họ tên!', 'danger');
                return;
            }

            $.ajax({
                url: '@Url.Action("CapNhatThongTin", "User")',
                type: 'POST',
                data: {
                    hoTen: hoTen,
                    soDienThoai: soDienThoai
                },
                success: function(res) {
                    if (res.success) {
                        showMessage('profileMessage', res.msg, 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        showMessage('profileMessage', res.msg, 'danger');
                    }
                },
                error: function() {
                    showMessage('profileMessage', 'Lỗi kết nối server!', 'danger');
                }
            });
        }

        function doiMatKhau() {
            var matKhauCu = $('#txtMatKhauCu').val();
            var matKhauMoi = $('#txtMatKhauMoi').val();
            var xacNhanMatKhau = $('#txtXacNhanMatKhau').val();

            if (!matKhauCu || !matKhauMoi || !xacNhanMatKhau) {
                showMessage('passwordMessage', 'Vui lòng điền đầy đủ thông tin!', 'danger');
                return;
            }

            if (matKhauMoi.length < 6) {
                showMessage('passwordMessage', 'Mật khẩu mới phải có ít nhất 6 ký tự!', 'danger');
                return;
            }

            if (matKhauMoi !== xacNhanMatKhau) {
                showMessage('passwordMessage', 'Mật khẩu mới và xác nhận không khớp!', 'danger');
                return;
            }

            $.ajax({
                url: '@Url.Action("DoiMatKhau", "User")',
                type: 'POST',
                data: {
                    matKhauCu: matKhauCu,
                    matKhauMoi: matKhauMoi,
                    xacNhanMatKhau: xacNhanMatKhau
                },
                success: function(res) {
                    if (res.success) {
                        showMessage('passwordMessage', res.msg, 'success');
                        $('#txtMatKhauCu').val('');
                        $('#txtMatKhauMoi').val('');
                        $('#txtXacNhanMatKhau').val('');
                    } else {
                        showMessage('passwordMessage', res.msg, 'danger');
                    }
                },
                error: function() {
                    showMessage('passwordMessage', 'Lỗi kết nối server!', 'danger');
                }
            });
        }

        function showMessage(elementId, message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            var html = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                       '<i class="fas ' + icon + '"></i> ' + message +
                       '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                       '</div>';

            $('#' + elementId).html(html);

            if (type === 'success') {
                setTimeout(function() {
                    $('#' + elementId + ' .alert').fadeOut();
                }, 3000);
            }
        }
    </script>
}