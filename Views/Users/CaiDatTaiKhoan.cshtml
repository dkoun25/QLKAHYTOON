@model QLKAHYTOON.Models.nguoidung
@{
    ViewBag.Title = "Cài đặt tài khoản";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* Background đen cho toàn bộ trang */
    body {
        background-color: #0a0a0a !important;
    }

    .settings-container {
        max-width: 900px;
        margin: 30px auto;
        padding: 20px;
        background-color: #0a0a0a;
    }

    .settings-header {
        text-align: center;
        margin-bottom: 40px;
        color: #fff;
        border-bottom: 2px solid #333;
        padding-bottom: 20px;
    }

        .settings-header h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

            .settings-header h2 i {
                color: #e50914;
                margin-right: 10px;
            }

        .settings-header p {
            color: #888;
            font-size: 14px;
            margin: 0;
        }

    .settings-card {
        background: #1a1a1a;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        border: 1px solid #2a2a2a;
        transition: all 0.3s ease;
    }

        .settings-card:hover {
            border-color: #333;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }

    .avatar-section {
        text-align: center;
        margin-bottom: 40px;
    }

    .avatar-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
    }

    .avatar-preview {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #2a2a2a;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .avatar-preview:hover {
            border-color: #e50914;
            transform: scale(1.05);
        }

    .avatar-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: rgba(229, 9, 20, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        cursor: pointer;
    }

    .avatar-wrapper:hover .avatar-overlay {
        opacity: 1;
    }

    .avatar-overlay i {
        font-size: 30px;
        color: white;
    }

    .section-title {
        color: #fff;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #333;
    }

        .section-title i {
            color: #e50914;
            margin-right: 10px;
        }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        color: #aaa;
        font-weight: 500;
        margin-bottom: 8px;
        display: block;
        font-size: 14px;
    }

    .form-control {
        background: #0a0a0a;
        border: 1px solid #2a2a2a;
        color: #fff;
        padding: 12px 15px;
        border-radius: 8px;
        transition: all 0.3s ease;
        width: 100%;
    }

        .form-control:focus {
            background: #111;
            border-color: #e50914;
            box-shadow: 0 0 0 0.2rem rgba(229, 9, 20, 0.25);
            color: #fff;
            outline: none;
        }

        .form-control:disabled {
            background: #0a0a0a;
            color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

    .text-muted {
        color: #666 !important;
        font-size: 12px;
        margin-top: 5px;
    }

    small.text-muted {
        display: block;
        margin-top: 5px;
    }

    .btn-save {
        background: linear-gradient(135deg, #e50914, #b20710);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-save:hover {
            background: linear-gradient(135deg, #f40612, #c90811);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 9, 20, 0.4);
            color: white;
        }

        .btn-save i {
            margin-right: 8px;
        }

    .btn-change-password {
        background: linear-gradient(135deg, #666, #444);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        cursor: pointer;
    }

        .btn-change-password:hover {
            background: linear-gradient(135deg, #777, #555);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 102, 102, 0.4);
            color: white;
        }

        .btn-change-password i {
            margin-right: 8px;
        }

    .alert {
        border-radius: 8px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    .alert-success {
        background: rgba(76, 175, 80, 0.15);
        border: 1px solid rgba(76, 175, 80, 0.4);
        color: #4CAF50;
    }

    .alert-danger {
        background: rgba(229, 9, 20, 0.15);
        border: 1px solid rgba(229, 9, 20, 0.4);
        color: #e50914;
    }

    .alert i {
        margin-right: 8px;
    }

    .btn-close {
        background: transparent;
        border: none;
        color: inherit;
        opacity: 0.5;
        cursor: pointer;
        float: right;
        font-size: 20px;
        line-height: 1;
        padding: 0;
        margin-left: 10px;
    }

        .btn-close:hover {
            opacity: 1;
        }

    #fileUpload {
        display: none;
    }

    /* Responsive Design */

    /* Tablet (768px - 1024px) */
    @@media (max-width: 1024px) {
        .settings-container {
            max-width: 800px;
            padding: 20px 15px;
        }

        .settings-card {
            padding: 25px;
        }
    }

    /* Tablet nhỏ (600px - 768px) */
    @@media (max-width: 768px) {
        .settings-container {
            padding: 15px 10px;
            margin: 20px auto;
        }

        .settings-header h2 {
            font-size: 24px;
        }

        .settings-header p {
            font-size: 13px;
        }

        .settings-card {
            padding: 20px;
            margin-bottom: 20px;
        }

        .avatar-preview,
        .avatar-overlay {
            width: 120px;
            height: 120px;
        }

            .avatar-overlay i {
                font-size: 24px;
            }

        .section-title {
            font-size: 18px;
        }

        .form-control {
            padding: 10px 12px;
            font-size: 14px;
        }

        .btn-save,
        .btn-change-password {
            padding: 10px 24px;
            font-size: 14px;
        }
    }

    /* Mobile (480px - 600px) */
    @@media (max-width: 600px) {
        .settings-container {
            padding: 10px 8px;
            margin: 15px auto;
        }

        .settings-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
        }

            .settings-header h2 {
                font-size: 22px;
            }

        .settings-card {
            padding: 18px;
            border-radius: 10px;
        }

        .avatar-section {
            margin-bottom: 30px;
        }

        .avatar-preview,
        .avatar-overlay {
            width: 100px;
            height: 100px;
        }

            .avatar-overlay i {
                font-size: 22px;
            }

        .section-title {
            font-size: 17px;
        }

        .form-label {
            font-size: 13px;
        }

        .text-muted {
            font-size: 11px;
        }
    }

    /* Mobile nhỏ (< 480px) */
    @@media (max-width: 480px) {
        .settings-container {
            padding: 8px 5px;
            margin: 10px auto;
        }

        .settings-header h2 {
            font-size: 20px;
        }

        .settings-header p {
            font-size: 12px;
        }

        .settings-card {
            padding: 15px;
            margin-bottom: 15px;
        }

        .avatar-preview,
        .avatar-overlay {
            width: 90px;
            height: 90px;
            border-width: 3px;
        }

            .avatar-overlay i {
                font-size: 20px;
            }

        .section-title {
            font-size: 16px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            padding: 10px;
            font-size: 13px;
        }

        .btn-save,
        .btn-change-password {
            width: 100%;
            padding: 10px 20px;
            font-size: 13px;
        }

        .alert {
            padding: 12px 15px;
            font-size: 13px;
        }
    }

    /* Mobile rất nhỏ (< 360px) */
    @@media (max-width: 360px) {
        .settings-header h2 {
            font-size: 18px;
        }

        .avatar-preview,
        .avatar-overlay {
            width: 80px;
            height: 80px;
        }

        .section-title {
            font-size: 15px;
        }

        .form-control {
            font-size: 12px;
        }

        .btn-save,
        .btn-change-password {
            padding: 8px 16px;
            font-size: 12px;
        }
    }
</style>

<div class="container settings-container">
    <div class="settings-header">
        <h2><i class="fas fa-cog"></i> Cài đặt tài khoản</h2>
        <p>Quản lý thông tin cá nhân và bảo mật</p>
    </div>

    <!-- AVATAR SECTION -->
    <div class="settings-card">
        <div class="avatar-section">
            <div class="avatar-wrapper">
                <img id="avatarPreview"
                     src="@(string.IsNullOrEmpty(Model.Avatar) ? "/Anh/Avatar/default-avatar.png" : Model.Avatar)"
                     alt="Avatar"
                     class="avatar-preview"
                     onclick="document.getElementById('fileUpload').click()">
                <div class="avatar-overlay" onclick="document.getElementById('fileUpload').click()">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <input type="file" id="fileUpload" accept="image/*" onchange="uploadAvatar()" />
            <p class="text-muted mt-2">
                <small>Click vào ảnh để thay đổi (JPG, PNG, GIF - Tối đa 5MB)</small>
            </p>
        </div>
    </div>

    <!-- THÔNG TIN CÁ NHÂN -->
    <div class="settings-card">
        <h3 class="section-title">
            <i class="fas fa-user"></i> Thông tin cá nhân
        </h3>

        <div id="profileMessage"></div>

        <div class="form-group">
            <label class="form-label">Tên đăng nhập</label>
            <input type="text" class="form-control" value="@Model.TenDangNhap" readonly disabled>
            <small class="text-muted">Không thể thay đổi tên đăng nhập</small>
        </div>

        <div class="form-group">
            <label class="form-label">Họ và tên</label>
            <input type="text" id="txtHoTen" class="form-control" value="@Model.HoTen" placeholder="Nhập họ tên">
        </div>

        <div class="form-group">
            <label class="form-label">Số điện thoại</label>
            <input type="text" id="txtSoDienThoai" class="form-control" value="@Model.SoDienThoai" placeholder="Nhập số điện thoại">
        </div>

        <button type="button" class="btn btn-save" onclick="capNhatThongTin()">
            <i class="fas fa-save"></i> Lưu thay đổi
        </button>
    </div>

    <!-- ĐỔI MẬT KHẨU -->
    <div class="settings-card">
        <h3 class="section-title">
            <i class="fas fa-lock"></i> Đổi mật khẩu
        </h3>

        <div id="passwordMessage"></div>

        <div class="form-group">
            <label class="form-label">Mật khẩu hiện tại</label>
            <input type="password" id="txtMatKhauCu" class="form-control" placeholder="Nhập mật khẩu hiện tại">
        </div>

        <div class="form-group">
            <label class="form-label">Mật khẩu mới</label>
            <input type="password" id="txtMatKhauMoi" class="form-control" placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)">
        </div>

        <div class="form-group">
            <label class="form-label">Xác nhận mật khẩu mới</label>
            <input type="password" id="txtXacNhanMatKhau" class="form-control" placeholder="Nhập lại mật khẩu mới">
        </div>

        <button type="button" class="btn btn-change-password" onclick="doiMatKhau()">
            <i class="fas fa-key"></i> Đổi mật khẩu
        </button>
    </div>
</div>

@section scripts {
    <script>
        function uploadAvatar() {
            var fileInput = document.getElementById('fileUpload');
            var file = fileInput.files[0];

            if (!file) return;

            // Preview ảnh trước khi upload
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);

            // Upload lên server
            var formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '@Url.Action("UploadAvatar", "Users")',  // ✅ Sửa từ "User" → "Users"
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(res) {
                    if (res.success) {
                        alert('✅ ' + res.msg);
                        document.getElementById('avatarPreview').src = res.avatarUrl;
                    } else {
                        alert('❌ ' + res.msg);
                        location.reload();
                    }
                },
                error: function() {
                    alert('❌ Lỗi kết nối server!');
                    location.reload();
                }
            });
        }

        function capNhatThongTin() {
            var hoTen = $('#txtHoTen').val().trim();
            var soDienThoai = $('#txtSoDienThoai').val().trim();

            if (!hoTen) {
                showMessage('profileMessage', 'Vui lòng nhập họ tên!', 'danger');
                return;
            }

            $.ajax({
                url: '@Url.Action("CapNhatThongTin", "Users")',  // ✅ Sửa từ "User" → "Users"
                type: 'POST',
                data: {
                    hoTen: hoTen,
                    soDienThoai: soDienThoai
                },
                success: function(res) {
                    if (res.success) {
                        showMessage('profileMessage', res.msg, 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        showMessage('profileMessage', res.msg, 'danger');
                    }
                },
                error: function() {
                    showMessage('profileMessage', 'Lỗi kết nối server!', 'danger');
                }
            });
        }

        function doiMatKhau() {
            var matKhauCu = $('#txtMatKhauCu').val();
            var matKhauMoi = $('#txtMatKhauMoi').val();
            var xacNhanMatKhau = $('#txtXacNhanMatKhau').val();

            if (!matKhauCu || !matKhauMoi || !xacNhanMatKhau) {
                showMessage('passwordMessage', 'Vui lòng điền đầy đủ thông tin!', 'danger');
                return;
            }

            if (matKhauMoi.length < 6) {
                showMessage('passwordMessage', 'Mật khẩu mới phải có ít nhất 6 ký tự!', 'danger');
                return;
            }

            if (matKhauMoi !== xacNhanMatKhau) {
                showMessage('passwordMessage', 'Mật khẩu mới và xác nhận không khớp!', 'danger');
                return;
            }

            $.ajax({
                url: '@Url.Action("DoiMatKhau", "Users")',  // ✅ Sửa từ "User" → "Users"
                type: 'POST',
                data: {
                    matKhauCu: matKhauCu,
                    matKhauMoi: matKhauMoi,
                    xacNhanMatKhau: xacNhanMatKhau
                },
                success: function(res) {
                    if (res.success) {
                        showMessage('passwordMessage', res.msg, 'success');
                        $('#txtMatKhauCu').val('');
                        $('#txtMatKhauMoi').val('');
                        $('#txtXacNhanMatKhau').val('');
                    } else {
                        showMessage('passwordMessage', res.msg, 'danger');
                    }
                },
                error: function() {
                    showMessage('passwordMessage', 'Lỗi kết nối server!', 'danger');
                }
            });
        }

        function showMessage(elementId, message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

            var html = '<div class="alert ' + alertClass + ' alert-dismissible fade show" role="alert">' +
                       '<i class="fas ' + icon + '"></i> ' + message +
                       '<button type="button" class="btn-close" data-bs-dismiss="alert">×</button>' +
                       '</div>';

            $('#' + elementId).html(html);

            if (type === 'success') {
                setTimeout(function() {
                    $('#' + elementId + ' .alert').fadeOut();
                }, 3000);
            }
        }
    </script>
}