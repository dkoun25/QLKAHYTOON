@model QLKAHYTOON.Models.thongtintruyen
@{
    ViewBag.Title = Model.TenTruyen;
    var danhSachChuong = ViewBag.DanhSachChuong as List<QLKAHYTOON.Models.chuong>;
    var danhSachTheLoai = ViewBag.DanhSachTheLoai as List<QLKAHYTOON.Models.theloai>;
    var soLuotTheoDoi = ViewBag.SoLuotTheoDoi ?? 0;
    var daTheoDoi = ViewBag.DaTheoDoi ?? false;

    // Check cả user và admin
    var user = Session["User"] as QLKAHYTOON.Models.nguoidung;
    var admin = Session["User"] as QLKAHYTOON.Models.admin;
    bool isLoggedIn = (user != null || admin != null);

    string currentUserId = "";
    if (isLoggedIn)
    {
        currentUserId = user != null ? user.MaNguoiDung : admin.MaAdmin;
    }
}

@section Styles {
    <link href="@Url.Content("~/Content/Chitiet.css")" rel="stylesheet" type="text/css" />
    <style>
        /* Rating System Styles */
        .star-rating-wrapper {
            display: inline-block;
            position: relative;
        }

        .star-rating {
            display: inline-flex;
            gap: 5px;
            cursor: pointer;
            user-select: none;
            font-size: 28px;
        }

            .star-rating .star {
                color: #ddd;
                transition: all 0.2s ease;
                cursor: pointer;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }

                .star-rating .star:hover {
                    transform: scale(1.15);
                }

                .star-rating .star.active {
                    color: #ffc107;
                    text-shadow: 0 2px 4px rgba(255, 193, 7, 0.5);
                }

                .star-rating .star.hover {
                    color: #ffdb4d;
                }

        .rating-info {
            display: inline-block;
            margin-left: 10px;
            vertical-align: middle;
        }

            .rating-info .avg-rating {
                font-size: 20px;
                font-weight: bold;
                color: #333;
            }

            .rating-info .total-ratings {
                font-size: 14px;
                color: #666;
            }

        /* Debug mode */
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
            display: none; /* Ẩn khi không debug */
        }
    </style>
}

<div class="row comic-info-container">
    <div class="col-md-3 col-sm-4 anhtruyen">
        <div class="img-wrapper">
            <img src="@Model.AnhTruyen" class="img-fluid shadow rounded" alt="@Model.TenTruyen" />
        </div>
    </div>

    <div class="col-md-9 col-sm-8">
        <h2 class="comic-title">@Model.TenTruyen</h2>

        <ul class="list-unstyled comic-meta">
            <li><strong><i class="fa fa-user"></i> Tác giả:</strong> @Model.TacGia</li>

            <li>
                <strong><i class="fa fa-tags"></i> Thể loại:</strong>
                @if (danhSachTheLoai != null && danhSachTheLoai.Any())
                {
                    foreach (var tl in danhSachTheLoai)
                    {
                        <a href="@Url.Action("TheLoai", "Home", new { id = tl.MaTheLoai.Trim() })" class="badge bg-secondary text-decoration-none">
                            @tl.TenTheLoai
                        </a>
                    }
                }
                else
                {
                    <span class="text-muted">Đang cập nhật</span>
                }
            </li>

            <li><strong><i class="fa fa-info-circle"></i> Trạng thái:</strong> <span class="text-primary">@Model.TrangThai</span></li>
            <li>
                <strong><i class="fa fa-calendar"></i> Ngày đăng:</strong>
                @(Model.NgayDang.HasValue ? Model.NgayDang.Value.ToString("dd/MM/yyyy") : "N/A")
            </li>
            <li><strong><i class="fa fa-eye"></i> Lượt xem:</strong> @Model.lichsudocs.Count</li>
            <li><strong><i class="fa fa-heart text-danger"></i> Lượt thích:</strong> <span id="luotThichCount">@(Model.LuotThich ?? 0)</span></li>
            <li><strong><i class="fa fa-bookmark text-warning"></i> Lượt theo dõi:</strong> <span id="luotTheoDoiCount">@soLuotTheoDoi</span></li>

            <li>
                <strong><i class="fa fa-star text-warning"></i> Đánh giá:</strong>
                <div class="star-rating-wrapper">
                    <div class="star-rating"
                         id="starRating"
                         data-ma-truyen="@Model.MaTruyen.Trim()"
                         data-logged-in="@isLoggedIn.ToString().ToLower()"
                         data-user-id="@currentUserId">
                        <i class="fa fa-star star" data-rating="1"></i>
                        <i class="fa fa-star star" data-rating="2"></i>
                        <i class="fa fa-star star" data-rating="3"></i>
                        <i class="fa fa-star star" data-rating="4"></i>
                        <i class="fa fa-star star" data-rating="5"></i>
                    </div>
                    <div class="rating-info">
                        <span class="avg-rating" id="avgRating">0.0</span>
                        <span class="total-ratings text-muted">(<span id="totalRatings">0</span> lượt)</span>
                    </div>
                </div>
            </li>
        </ul>

        <!-- Debug Info (Bật lên khi cần debug) -->
        <div class="debug-info" id="debugInfo">
            <strong>DEBUG INFO:</strong><br>
            Logged In: <span id="debugLoggedIn">@isLoggedIn</span><br>
            User ID: <span id="debugUserId">@currentUserId</span><br>
            Manga ID: <span id="debugMangaId">@Model.MaTruyen.Trim()</span><br>
            Last Action: <span id="debugLastAction">-</span>
        </div>

        <div class="form-btn mt-3">
            @if (danhSachChuong != null && danhSachChuong.Any())
            {
                <a href="@Url.Action("DocTruyen", "Truyen", new { id = danhSachChuong.First().MaChuong.Trim() })" class="btn btn-danger btn-lg">
                    <i class="fa fa-book"></i> Đọc Ngay
                </a>
            }
            <button class="btn btn-outline-success" id="btnThich" onclick="thichTruyen()">
                <i class="fa fa-heart"></i> <span id="btnThichText">Thích</span>
            </button>
            <button class="btn btn-outline-primary @(daTheoDoi ? "active" : "")" id="btnTheoDoi" onclick="theoDoiTruyen()">
                <i class="fa fa-bell"></i> <span id="btnTheoDoiText">@(daTheoDoi ? "Đã theo dõi" : "Theo dõi")</span>
            </button>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4 class="mb-0"><i class="fa fa-list"></i> Danh sách chương</h4>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush chapter-list">
                    @if (danhSachChuong != null && danhSachChuong.Any())
                    {
                        foreach (var chuong in danhSachChuong)
                        {
                            <a href="@Url.Action("DocTruyen", "Truyen", new { id = chuong.MaChuong.Trim() })" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Chương @chuong.SoChuong: @chuong.TenChuong</span>
                                    <small class="text-muted">
                                        @(chuong.NgayDang.HasValue ? chuong.NgayDang.Value.ToString("dd/MM/yyyy") : "")
                                    </small>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <p class="p-3 text-center text-muted">Truyện này chưa cập nhật chương mới.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <hr />
    <input type="hidden" id="hdMaTruyen" value="@Model.MaTruyen.Trim()" />
    <input type="hidden" id="hdMaChuong" value="" />
    @Html.Action("ListBinhLuan", "BinhLuan", new { maTruyen = Model.MaTruyen, isDetail = true })
</div>

<!-- THAY THẾ phần scripts trong ChiTiet.cshtml -->

@section scripts {
    <script>
    // ============================================================
    // GLOBAL VARIABLES
    // ============================================================
    var ratingSystem = {
        isLoggedIn: false,
        maTruyen: '',
        currentUserRating: 0,
        isProcessing: false
    };

    var likeSystem = {
        daThich: false,
        isProcessing: false
    };

    // ============================================================
    // DOCUMENT READY
    // ============================================================
    $(document).ready(function() {
        console.log('=== PAGE INITIALIZING ===');

        // Initialize rating system
        initRatingSystem();
        loadRating();

        // Initialize like system
        checkDaThich();

        console.log('=== PAGE INITIALIZED ===');
    });

    // ============================================================
    // CHECK ĐÃ THÍCH CHƯA
    // ============================================================
    function checkDaThich() {
        var maTruyen = $('#hdMaTruyen').val();

        $.ajax({
            url: '@Url.Action("CheckDaThich", "Truyen")',
            type: 'GET',
            data: { maTruyen: maTruyen },
            success: function(res) {
                likeSystem.daThich = res.daThich;

                if (res.daThich) {
                    $('#btnThich').removeClass('btn-outline-success').addClass('btn-success');
                    $('#btnThichText').text('Đã thích');
                    $('#btnThich').prop('disabled', true);
                }
            },
            error: function(xhr, status, error) {
                console.error('Check like error:', error);
            }
        });
    }

    // ============================================================
    // THÍCH TRUYỆN
    // ============================================================
    function thichTruyen() {
        if (likeSystem.isProcessing) {
            console.log('Like is processing...');
            return;
        }

        if (likeSystem.daThich) {
            alert('Bạn đã thích truyện này rồi!');
            return;
        }

        likeSystem.isProcessing = true;
        $('#btnThich').prop('disabled', true);

        var maTruyen = $('#hdMaTruyen').val();

        $.ajax({
            url: '@Url.Action("ThichTruyen", "Truyen")',
            type: 'POST',
            data: { maTruyen: maTruyen },
            success: function(res) {
                likeSystem.isProcessing = false;

                if (res.success) {
                    likeSystem.daThich = true;
                    $('#luotThichCount').text(res.luotThich);
                    $('#btnThich').removeClass('btn-outline-success').addClass('btn-success');
                    $('#btnThichText').text('Đã thích');
                    $('#btnThich').prop('disabled', true);
                    alert('✅ ' + (res.msg || 'Đã thích truyện thành công!'));
                } else {
                    $('#btnThich').prop('disabled', false);
                    
                    if (res.alreadyLiked) {
                        likeSystem.daThich = true;
                        $('#btnThich').removeClass('btn-outline-success').addClass('btn-success');
                        $('#btnThichText').text('Đã thích');
                        $('#btnThich').prop('disabled', true);
                    }
                    
                    alert('❌ ' + (res.msg || 'Có lỗi xảy ra!'));

                    // Check if need login
                    if (res.msg && res.msg.includes('đăng nhập')) {
                        if (confirm('Chuyển đến trang đăng nhập?')) {
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                }
            },
            error: function() {
                likeSystem.isProcessing = false;
                $('#btnThich').prop('disabled', false);
                alert('❌ Lỗi kết nối server!');
            }
        });
    }

    // ============================================================
    // THEO DÕI TRUYỆN
    // ============================================================
    function theoDoiTruyen() {
        var maTruyen = $('#hdMaTruyen').val();

        $.ajax({
            url: '@Url.Action("TheoDoiTruyen", "Truyen")',
            type: 'POST',
            data: { maTruyen: maTruyen },
            success: function(res) {
                if (res.success) {
                    $('#luotTheoDoiCount').text(res.soLuotTheoDoi);

                    if (res.daTheoDoi) {
                        $('#btnTheoDoi').addClass('active');
                        $('#btnTheoDoiText').text('Đã theo dõi');
                    } else {
                        $('#btnTheoDoi').removeClass('active');
                        $('#btnTheoDoiText').text('Theo dõi');
                    }
                } else {
                    alert('❌ ' + (res.msg || 'Có lỗi xảy ra!'));
                    
                    if (res.msg && res.msg.includes('đăng nhập')) {
                        if (confirm('Chuyển đến trang đăng nhập?')) {
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                }
            },
            error: function() {
                alert('❌ Lỗi kết nối server!');
            }
        });
    }

    // ============================================================
    // RATING SYSTEM - INITIALIZE
    // ============================================================
    function initRatingSystem() {
        var $starRating = $('#starRating');
        var $stars = $('.star');

        ratingSystem.isLoggedIn = $starRating.data('logged-in') === true || $starRating.data('logged-in') === 'true';
        ratingSystem.maTruyen = $starRating.data('ma-truyen');

        console.log('Rating System Config:', {
            isLoggedIn: ratingSystem.isLoggedIn,
            maTruyen: ratingSystem.maTruyen
        });

        updateDebugInfo('Initialized');

        $stars.on('mouseenter', function() {
            if (ratingSystem.isProcessing) return;
            var rating = $(this).data('rating');
            highlightStarsHover(rating);
        });

        $starRating.on('mouseleave', function() {
            if (ratingSystem.isProcessing) return;
            highlightStars(ratingSystem.currentUserRating);
        });

        $stars.on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            if (ratingSystem.isProcessing) {
                console.log('Rating is processing, please wait...');
                return;
            }

            var rating = $(this).data('rating');
            console.log('Star clicked:', rating);
            handleStarClick(rating);
        });
    }

    // ============================================================
    // RATING SYSTEM - HANDLE CLICK
    // ============================================================
    function handleStarClick(rating) {
        console.log('handleStarClick called with rating:', rating);
        updateDebugInfo('Star clicked: ' + rating);

        if (!ratingSystem.isLoggedIn) {
            console.log('User not logged in');
            updateDebugInfo('Not logged in');

            if (confirm('Bạn cần đăng nhập để đánh giá truyện.\n\nBạn có muốn chuyển đến trang đăng nhập không?')) {
                window.location.href = '@Url.Action("Login", "Account")';
            }
            return;
        }

        ratingSystem.isProcessing = true;
        $('.star').css('pointer-events', 'none').css('opacity', '0.6');
        updateDebugInfo('Sending rating...');

        $.ajax({
            url: '@Url.Action("RateTruyen", "Truyen")',
            type: 'POST',
            data: {
                maTruyen: ratingSystem.maTruyen,
                rating: rating
            },
            success: function(res) {
                console.log('Rating response:', res);
                updateDebugInfo('Response received');

                ratingSystem.isProcessing = false;
                $('.star').css('pointer-events', 'auto').css('opacity', '1');

                if (res.success) {
                    ratingSystem.currentUserRating = rating;
                    highlightStars(rating);

                    $('#avgRating').text(res.avgRating.toFixed(1));
                    $('#totalRatings').text(res.totalRatings);

                    updateDebugInfo('Rating saved: ' + rating + ' stars');
                    alert('✨ Cảm ơn bạn đã đánh giá ' + rating + ' sao cho truyện này!');
                } else {
                    console.error('Rating failed:', res.msg);
                    updateDebugInfo('Error: ' + res.msg);
                    alert('❌ ' + (res.msg || 'Có lỗi xảy ra!'));

                    if (res.msg && res.msg.includes('đăng nhập')) {
                        if (confirm('Chuyển đến trang đăng nhập?')) {
                            window.location.href = '@Url.Action("Login", "Account")';
                        }
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', {
                    status: status,
                    error: error,
                    response: xhr.responseText
                });

                ratingSystem.isProcessing = false;
                $('.star').css('pointer-events', 'auto').css('opacity', '1');

                updateDebugInfo('AJAX Error: ' + error);
                alert('❌ Lỗi kết nối server!\n\nChi tiết: ' + error);
            }
        });
    }

    // ============================================================
    // RATING SYSTEM - LOAD FROM SERVER
    // ============================================================
    function loadRating() {
        console.log('Loading rating for:', ratingSystem.maTruyen);
        updateDebugInfo('Loading rating...');

        $.ajax({
            url: '@Url.Action("GetRating", "Truyen")',
            type: 'GET',
            data: { maTruyen: ratingSystem.maTruyen },
            success: function(res) {
                console.log('Load rating response:', res);

                if (res.success) {
                    $('#avgRating').text(res.avgRating.toFixed(1));
                    $('#totalRatings').text(res.totalRatings);

                    if (res.userRating > 0) {
                        ratingSystem.currentUserRating = res.userRating;
                        highlightStars(res.userRating);
                        console.log('User has rated:', res.userRating, 'stars');
                        updateDebugInfo('Loaded - User rated: ' + res.userRating);
                    } else {
                        updateDebugInfo('Loaded - No user rating');
                    }
                } else {
                    console.error('Load rating failed:', res.msg);
                    updateDebugInfo('Load error: ' + res.msg);
                }
            },
            error: function(xhr, status, error) {
                console.error('Load rating error:', error);
                updateDebugInfo('Load error: ' + error);
            }
        });
    }

    // ============================================================
    // RATING SYSTEM - HIGHLIGHT STARS
    // ============================================================
    function highlightStars(rating) {
        $('.star').each(function() {
            var starRating = $(this).data('rating');
            if (starRating <= rating) {
                $(this).addClass('active').removeClass('hover');
            } else {
                $(this).removeClass('active hover');
            }
        });
    }

    function highlightStarsHover(rating) {
        $('.star').each(function() {
            var starRating = $(this).data('rating');
            if (starRating <= rating) {
                $(this).addClass('hover');
            } else {
                $(this).removeClass('hover');
            }
        });
    }

    // ============================================================
    // DEBUG
    // ============================================================
    function updateDebugInfo(action) {
        $('#debugLastAction').text(action + ' (' + new Date().toLocaleTimeString() + ')');
    }

    // UNCOMMENT TO ENABLE DEBUG MODE
    // $('#debugInfo').show();
    </script>
}

<style>
    .btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
</style>