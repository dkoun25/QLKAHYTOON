@model QLKAHYTOON.Models.thongtintruyen
@{
    ViewBag.Title = Model.TenTruyen;
    var danhSachChuong = ViewBag.DanhSachChuong as List<QLKAHYTOON.Models.chuong>;
    var danhSachTheLoai = ViewBag.DanhSachTheLoai as List<QLKAHYTOON.Models.theloai>;
    var soLuotTheoDoi = ViewBag.SoLuotTheoDoi ?? 0;
    var daTheoDoi = ViewBag.DaTheoDoi ?? false;
}

@section Styles {
    <link href="@Url.Content("~/Content/Chitiet.css")" rel="stylesheet" type="text/css" />
}

<div class="row comic-info-container">
    <div class="col-md-3 col-sm-4 anhtruyen">
        <div class="img-wrapper">
            <img src="@Model.AnhTruyen" class="img-fluid shadow rounded" alt="@Model.TenTruyen" />
        </div>
    </div>

    <div class="col-md-9 col-sm-8">
        <h2 class="comic-title">@Model.TenTruyen</h2>

        <ul class="list-unstyled comic-meta">
            <li><strong><i class="fa fa-user"></i> Tác giả:</strong> @Model.TacGia</li>

            <li>
                <strong><i class="fa fa-tags"></i> Thể loại:</strong>
                @if (danhSachTheLoai != null && danhSachTheLoai.Any())
                {
                    foreach (var tl in danhSachTheLoai)
                    {
                        <a href="@Url.Action("TheLoai", "Home", new { id = tl.MaTheLoai.Trim() })" class="badge bg-secondary text-decoration-none">
                            @tl.TenTheLoai
                        </a>
                    }
                }
                else
                {
                    <span class="text-muted">Đang cập nhật</span>
                }
            </li>

            <li><strong><i class="fa fa-info-circle"></i> Trạng thái:</strong> <span class="text-primary">@Model.TrangThai</span></li>
            <li>
                <strong><i class="fa fa-calendar"></i> Ngày đăng:</strong>
                @(Model.NgayDang.HasValue ? Model.NgayDang.Value.ToString("dd/MM/yyyy") : "N/A")
            </li>
            <li><strong><i class="fa fa-eye"></i> Lượt xem:</strong> @Model.lichsudocs.Count</li>
            <li><strong><i class="fa fa-heart text-danger"></i> Lượt thích:</strong> <span id="luotThichCount">@(Model.LuotThich ?? 0)</span></li>
            <li><strong><i class="fa fa-bookmark text-warning"></i> Lượt theo dõi:</strong> <span id="luotTheoDoiCount">@soLuotTheoDoi</span></li>
        </ul>

        <div class="form-btn mt-3">
            @if (danhSachChuong != null && danhSachChuong.Any())
            {
                <a href="@Url.Action("DocTruyen", "Truyen", new { id = danhSachChuong.First().MaChuong.Trim() })" class="btn btn-danger btn-lg">
                    <i class="fa fa-book"></i> Đọc Ngay
                </a>
            }
            <button class="btn btn-outline-success" id="btnThich" onclick="thichTruyen()">
                <i class="fa fa-heart"></i> <span id="btnThichText">Thích</span>
            </button>
            <button class="btn btn-outline-primary @(daTheoDoi ? "active" : "")" id="btnTheoDoi" onclick="theoDoiTruyen()">
                <i class="fa fa-bell"></i> <span id="btnTheoDoiText">@(daTheoDoi ? "Đã theo dõi" : "Theo dõi")</span>
            </button>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h4 class="mb-0"><i class="fa fa-list"></i> Danh sách chương</h4>
            </div>
            <div class="card-body p-0">
                <div class="list-group list-group-flush chapter-list">
                    @if (danhSachChuong != null && danhSachChuong.Any())
                    {
                        foreach (var chuong in danhSachChuong)
                        {
                            <a href="@Url.Action("DocTruyen", "Truyen", new { id = chuong.MaChuong.Trim() })" class="list-group-item list-group-item-action">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="fw-bold">Chương @chuong.SoChuong: @chuong.TenChuong</span>
                                    <small class="text-muted">
                                        @(chuong.NgayDang.HasValue ? chuong.NgayDang.Value.ToString("dd/MM/yyyy") : "")
                                    </small>
                                </div>
                            </a>
                        }
                    }
                    else
                    {
                        <p class="p-3 text-center text-muted">Truyện này chưa cập nhật chương mới.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <hr />
    <input type="hidden" id="hdMaTruyen" value="@Model.MaTruyen.Trim()" />
    <input type="hidden" id="hdMaChuong" value="" />
    @Html.Action("ListBinhLuan", "BinhLuan", new { maTruyen = Model.MaTruyen, isDetail = true })
</div>

<script>
    function thichTruyen() {
        var maTruyen = document.getElementById('hdMaTruyen').value;

        $.ajax({
            url: '@Url.Action("ThichTruyen", "Truyen")',
            type: 'POST',
            data: { maTruyen: maTruyen },
            success: function(res) {
                if (res.success) {
                    // Cập nhật số lượt thích
                    $('#luotThichCount').text(res.luotThich);

                    // Đổi màu nút
                    $('#btnThich').removeClass('btn-outline-success').addClass('btn-success');
                    $('#btnThichText').text('Đã thích');

                    // Disable nút sau khi thích
                    $('#btnThich').prop('disabled', true);
                } else {
                    alert(res.msg || 'Có lỗi xảy ra!');
                }
            },
            error: function() {
                alert('Lỗi kết nối server!');
            }
        });
    }

    function theoDoiTruyen() {
        var maTruyen = document.getElementById('hdMaTruyen').value;

        $.ajax({
            url: '@Url.Action("TheoDoiTruyen", "Truyen")',
            type: 'POST',
            data: { maTruyen: maTruyen },
            success: function(res) {
                if (res.success) {
                    // Cập nhật số lượt theo dõi
                    $('#luotTheoDoiCount').text(res.soLuotTheoDoi);

                    if (res.daTheoDoi) {
                        // Đã theo dõi
                        $('#btnTheoDoi').addClass('active');
                        $('#btnTheoDoiText').text('Đã theo dõi');
                    } else {
                        // Bỏ theo dõi
                        $('#btnTheoDoi').removeClass('active');
                        $('#btnTheoDoiText').text('Theo dõi');
                    }
                } else {
                    alert(res.msg || 'Có lỗi xảy ra!');
                }
            },
            error: function() {
                alert('Lỗi kết nối server!');
            }
        });
    }
</script>

<style>
    .btn.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }
</style>